================================================================================
FEEDBACK & COMPLAINTS SERVICE - POSTMAN TESTING GUIDE
================================================================================
Service Port: 3007
Base URL: http://localhost:3007/api/feedback

================================================================================
AUTHENTICATION SETUP
================================================================================
Before testing, you need a valid JWT token:

1. Login as CLIENT:
   POST http://localhost:3000/api/auth/login
   Body (JSON):
   {
     "username": "aziz",
     "password": "your_password"
   }
   Copy the "accessToken" from response

2. Login as ADMIN:
   POST http://localhost:3000/api/auth/login
   Body (JSON):
   {
     "username": "admin,
     "password": "Admin123!"
   }
   Copy the "accessToken" from response

3. Add to Postman Headers for all requests:
   Authorization: Bearer YOUR_JWT_TOKEN_HERE

================================================================================
1. HEALTH CHECK (No Authentication Required)
================================================================================
GET http://localhost:3007/health

Expected Response:
{
  "success": true,
  "message": "Feedback & Complaints Service is running",
  "timestamp": "2025-11-26T...",
  "service": "feedback-complaints-service",
  "version": "1.0.0"
}

================================================================================
2. CREATE FEEDBACK/COMPLAINT (USER)
================================================================================
POST http://localhost:3007/api/feedback
Headers: Authorization: Bearer USER_TOKEN

Body (JSON) - Example 1 (Complaint):
{
  "type": "complaint",
  "category": "vehicle_issue",
  "priority": "high",
  "subject": "Car had mechanical issues",
  "description": "The car I rented had engine problems and broke down on the highway. This was very dangerous and inconvenient.",
  "relatedTo": {
    "type": "reservation",
    "referenceId": "507f1f77bcf86cd799439011"
  },
  "isAnonymous": false
}

Body (JSON) - Example 2 (Feedback):
{
  "type": "feedback",
  "category": "customer_support",
  "priority": "medium",
  "subject": "Excellent service at pickup",
  "description": "The staff at the pickup location were very helpful and professional. Great experience!",
  "isAnonymous": false
}

Body (JSON) - Example 3 (Report):
{
  "type": "report",
  "category": "technical_issue",
  "priority": "urgent",
  "subject": "Website payment page not working",
  "description": "Cannot complete payment on the website. The page keeps crashing.",
  "isAnonymous": true,
  "contactInfo": {
    "email": "reporter@example.com",
    "phone": "+1234567890"
  }
}

Expected Response:
{
  "success": true,
  "message": "Feedback submitted successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "userType": "client",
      "type": "complaint",
      "category": "vehicle_issue",
      "priority": "high",
      "subject": "Car had mechanical issues",
      "description": "...",
      "status": "pending",
      "isAnonymous": false,
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
3. GET MY FEEDBACK (USER)
================================================================================
GET http://localhost:3007/api/feedback/my-feedback
Headers: Authorization: Bearer USER_TOKEN

Query Parameters (optional):
- status: pending, in_progress, resolved, closed, rejected
- type: feedback, complaint, report, suggestion
- page: 1, 2, 3...
- limit: 10, 20, 50...

Examples:
GET http://localhost:3007/api/feedback/my-feedback?status=pending&page=1&limit=10
GET http://localhost:3007/api/feedback/my-feedback?type=complaint

Expected Response:
{
  "success": true,
  "data": {
    "feedback": [
      {
        "_id": "...",
        "userId": "...",
        "userType": "client",
        "type": "complaint",
        "category": "vehicle_issue",
        "priority": "high",
        "subject": "Car had mechanical issues",
        "description": "...",
        "status": "pending",
        "createdAt": "2025-11-26T...",
        "updatedAt": "2025-11-26T..."
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 3,
      "totalItems": 25,
      "itemsPerPage": 10
    }
  }
}

================================================================================
4. GET FEEDBACK BY ID (USER)
================================================================================
GET http://localhost:3007/api/feedback/{feedbackId}
Headers: Authorization: Bearer USER_TOKEN

Example:
GET http://localhost:3007/api/feedback/507f1f77bcf86cd799439011

Expected Response:
{
  "success": true,
  "data": {
    "feedback": {
      "_id": "507f1f77bcf86cd799439011",
      "userId": "673e5f1a2b68820c416c6eef",
      "userType": "client",
      "type": "complaint",
      "category": "vehicle_issue",
      "priority": "high",
      "subject": "Car had mechanical issues",
      "description": "...",
      "status": "in_progress",
      "response": {
        "message": "We're looking into this issue",
        "respondedBy": "673e5f1a2b68820c416c6ef0",
        "respondedAt": "2025-11-26T..."
      },
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
5. RATE FEEDBACK RESOLUTION (USER)
================================================================================
PATCH http://localhost:3007/api/feedback/{feedbackId}/rate
Headers: Authorization: Bearer USER_TOKEN

Body (JSON):
{
  "rating": 5
}

Note: Rating must be between 1 and 5
Note: Only works for feedback with status "resolved"

Expected Response:
{
  "success": true,
  "message": "Rating submitted successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "type": "complaint",
      "status": "closed",
      "resolution": {
        "message": "Issue resolved...",
        "resolvedBy": "...",
        "resolvedAt": "2025-11-26T...",
        "satisfactionRating": 5
      },
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
6. DELETE MY FEEDBACK (USER)
================================================================================
DELETE http://localhost:3007/api/feedback/{feedbackId}
Headers: Authorization: Bearer USER_TOKEN

Example:
DELETE http://localhost:3007/api/feedback/507f1f77bcf86cd799439011

Note: Only works for feedback with status "pending"

Expected Response:
{
  "success": true,
  "message": "Feedback deleted successfully"
}

================================================================================
ADMIN ENDPOINTS (Requires Admin Role)
================================================================================

7. GET ALL FEEDBACK (ADMIN)
================================================================================
GET http://localhost:3007/api/feedback
Headers: Authorization: Bearer ADMIN_TOKEN

Query Parameters (optional):
- status: pending, in_progress, resolved, closed, rejected
- type: feedback, complaint, report, suggestion
- category: service_quality, vehicle_issue, payment_issue, etc.
- priority: low, medium, high, urgent
- assignedTo: admin_user_id
- userId: specific_user_id
- userType: client, agency
- page: 1
- limit: 10
- sortBy: createdAt, priority, status
- sortOrder: asc, desc

Examples:
GET http://localhost:3007/api/feedback?status=pending&priority=high&page=1&limit=20
GET http://localhost:3007/api/feedback?type=complaint&category=vehicle_quality
GET http://localhost:3007/api/feedback?assignedTo=507f1f77bcf86cd799439011

Expected Response:
{
  "success": true,
  "data": {
    "feedback": [
      {
        "_id": "...",
        "userId": {
          "_id": "...",
          "username": "aziz",
          "email": "aziz@example.com"
        },
        "userType": "client",
        "type": "complaint",
        "category": "vehicle_issue",
        "priority": "high",
        "subject": "...",
        "description": "...",
        "status": "pending",
        "createdAt": "2025-11-26T...",
        "updatedAt": "2025-11-26T..."
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 48,
      "itemsPerPage": 10
    }
  }
}

================================================================================
8. UPDATE FEEDBACK (ADMIN)
================================================================================
PATCH http://localhost:3007/api/feedback/{feedbackId}
Headers: Authorization: Bearer ADMIN_TOKEN

Body (JSON) - Example 1 (Change Status):
{
  "status": "in_progress"
}

Body (JSON) - Example 2 (Assign to Admin):
{
  "assignedTo": "507f1f77bcf86cd799439011",
  "priority": "urgent"
}

Body (JSON) - Example 3 (Update Priority):
{
  "priority": "high"
}

Expected Response:
{
  "success": true,
  "message": "Feedback updated successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "userType": "client",
      "type": "complaint",
      "category": "vehicle_issue",
      "priority": "urgent",
      "status": "in_progress",
      "assignedTo": "507f1f77bcf86cd799439011",
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
9. RESPOND TO FEEDBACK (ADMIN)
================================================================================
POST http://localhost:3007/api/feedback/{feedbackId}/respond
Headers: Authorization: Bearer ADMIN_TOKEN

Body (JSON):
{
  "message": "Thank you for reporting this issue. We have investigated and found that the vehicle had not been properly inspected. We apologize for the inconvenience and have refunded your rental fee."
}

Expected Response:
{
  "success": true,
  "message": "Response added successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "type": "complaint",
      "status": "in_progress",
      "response": {
        "message": "Thank you for reporting...",
        "respondedBy": "admin_user_id",
        "respondedAt": "2025-11-26T..."
      },
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
10. RESOLVE FEEDBACK (ADMIN)
================================================================================
POST http://localhost:3007/api/feedback/{feedbackId}/resolve
Headers: Authorization: Bearer ADMIN_TOKEN

Body (JSON):
{
  "message": "We have refunded the full rental amount and provided a 50% discount coupon for your next rental. The vehicle has been removed from our fleet for inspection."
}

Note: This will change status to "resolved"

Expected Response:
{
  "success": true,
  "message": "Feedback resolved successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "type": "complaint",
      "status": "resolved",
      "response": {
        "message": "Thank you for reporting...",
        "respondedBy": "...",
        "respondedAt": "2025-11-26T..."
      },
      "resolution": {
        "message": "We have refunded the full rental amount...",
        "resolvedBy": "admin_user_id",
        "resolvedAt": "2025-11-26T..."
      },
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
11. ADD INTERNAL NOTE (ADMIN)
================================================================================
POST http://localhost:3007/api/feedback/{feedbackId}/notes
Headers: Authorization: Bearer ADMIN_TOKEN

Body (JSON):
{
  "note": "Contacted the user via phone. They confirmed the issue was resolved satisfactorily."
}

Note: Internal notes are NOT visible to users, only to admins

Expected Response:
{
  "success": true,
  "message": "Internal note added successfully",
  "data": {
    "feedback": {
      "_id": "...",
      "userId": "...",
      "type": "complaint",
      "status": "in_progress",
      "internalNotes": [
        {
          "note": "Contacted the user via phone...",
          "addedBy": "admin_user_id",
          "addedAt": "2025-11-26T...",
          "_id": "..."
        }
      ],
      "createdAt": "2025-11-26T...",
      "updatedAt": "2025-11-26T..."
    }
  }
}

================================================================================
12. GET STATISTICS (ADMIN)
================================================================================
GET http://localhost:3007/api/feedback/admin/statistics
Headers: Authorization: Bearer ADMIN_TOKEN

Query Parameters (optional):
- startDate: 2025-01-01
- endDate: 2025-12-31

Examples:
GET http://localhost:3007/api/feedback/admin/statistics
GET http://localhost:3007/api/feedback/admin/statistics?startDate=2025-11-01&endDate=2025-11-30

Expected Response:
{
  "success": true,
  "data": {
    "totalFeedback": 150,
    "byStatus": {
      "pending": 25,
      "in_review": 15,
      "in_progress": 10,
      "resolved": 80,
      "closed": 20
    },
    "byType": {
      "feedback": 60,
      "complaint": 50,
      "report": 30,
      "suggestion": 10
    },
    "byCategory": {
      "vehicle_issue": 40,
      "customer_support": 35,
      "payment_issue": 20,
      "technical_issue": 15,
      "booking_issue": 10,
      ...
    },
    "byPriority": {
      "low": 40,
      "medium": 60,
      "high": 35,
      "urgent": 15
    },
    "averageResolutionTime": 48.5,
    "averageRating": 4.2,
    "totalRatings": 65
  }
}

================================================================================
ERROR RESPONSES
================================================================================

1. Validation Error (400):
{
  "success": false,
  "error": {
    "message": "Validation failed",
    "code": "VALIDATION_ERROR",
    "details": [
      {
        "type": "field",
        "value": "invalid_value",
        "msg": "Type must be one of: feedback, complaint, report, suggestion",
        "path": "type",
        "location": "body"
      }
    ]
  }
}

2. Authentication Error (401):
{
  "success": false,
  "error": {
    "message": "No token provided",
    "code": "NO_TOKEN"
  }
}
OR
{
  "success": false,
  "error": {
    "message": "Invalid or expired token",
    "code": "INVALID_TOKEN"
  }
}

3. Authorization Error (403):
{
  "success": false,
  "error": {
    "message": "Access denied. Admin role required.",
    "code": "FORBIDDEN"
  }
}

4. Not Found Error (404):
{
  "success": false,
  "error": {
    "message": "Feedback not found",
    "code": "FEEDBACK_NOT_FOUND"
  }
}

5. Conflict Error (400):
{
  "success": false,
  "error": {
    "message": "Feedback is not resolved yet. Cannot rate.",
    "code": "INVALID_STATUS"
  }
}

6. Server Error (500):
{
  "success": false,
  "error": {
    "message": "Failed to create feedback",
    "code": "CREATE_FEEDBACK_ERROR"
  }
}

================================================================================
TESTING WORKFLOW EXAMPLE
================================================================================

Complete Test Scenario: User Submits Complaint → Admin Responds → Resolves → User Rates

1. USER: Create complaint
   POST /api/feedback
   {
     "type": "complaint",
     "category": "vehicle_issue",
     "priority": "high",
     "subject": "Dirty car interior",
     "description": "The car was not cleaned before rental"
   }
   → Get feedback ID from response

2. USER: Check my feedback
   GET /api/feedback/my-feedback
   → Verify complaint appears with status "pending"

3. ADMIN: Get all pending feedback
   GET /api/feedback?status=pending
   → Find the complaint

4. ADMIN: Assign to self and update priority
   PATCH /api/feedback/{id}
   {
     "assignedTo": "admin_id",
     "status": "in_progress"
   }

5. ADMIN: Add internal note
   POST /api/feedback/{id}/notes
   {
     "note": "Contacted cleaning service. Will investigate."
   }

6. ADMIN: Respond to user
   POST /api/feedback/{id}/respond
   {
     "message": "We apologize for this. We're investigating with our cleaning service."
   }

7. USER: Check feedback status
   GET /api/feedback/{id}
   → See admin response

8. ADMIN: Update to in_progress
   PATCH /api/feedback/{id}
   {
     "status": "in_progress"
   }

9. ADMIN: Resolve the complaint
   POST /api/feedback/{id}/resolve
   {
     "message": "We have disciplined the cleaning staff and refunded 20% of your rental cost."
   }

10. USER: Rate the resolution
    PATCH /api/feedback/{id}/rate
    {
      "rating": 4
    }

11. ADMIN: Get statistics
    GET /api/feedback/admin/statistics
    → View overall metrics

================================================================================
POSTMAN COLLECTION SETUP TIPS
================================================================================

1. Create Environment Variables:
   - base_url: http://localhost:3007
   - user_token: (set after login)
   - admin_token: (set after admin login)
   - feedback_id: (set after creating feedback)

2. Use Pre-request Scripts to set tokens:
   pm.environment.set("user_token", "your_jwt_token");

3. Use Tests to extract values:
   // Save feedback ID
   var response = pm.response.json();
   pm.environment.set("feedback_id", response.data.feedback._id);

4. Create folder structure:
   - Health Check
   - User Endpoints
     - Create Feedback
     - Get My Feedback
     - Get by ID
     - Rate Resolution
     - Delete
   - Admin Endpoints
     - Get All
     - Update
     - Respond
     - Resolve
     - Add Note
     - Statistics

================================================================================
CATEGORIES REFERENCE
================================================================================
- service_quality
- vehicle_issue
- payment_issue
- booking_issue
- insurance_issue
- customer_support
- technical_issue
- safety_concern
- other

================================================================================
NOTES
================================================================================
- All timestamps are in ISO 8601 format
- MongoDB ObjectId format: 24 character hex string
- JWT tokens expire after configured time (check .env JWT_EXPIRES_IN)
- Attachments array is supported but file upload not implemented in this version
- Anonymous submissions require contactInfo field
- Only resolved feedback can be rated
- Only pending feedback can be deleted by users
- Resolution time is calculated in hours

================================================================================
