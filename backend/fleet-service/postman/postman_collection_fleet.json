{
  "info": {
    "_postman_id": "agency-fleet-service-collection",
    "name": "Agency Fleet Service - Tests with Categories",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Health",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/health",
          "host": ["{{baseUrl}}"],
          "path": ["health"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Health status 200', function () { pm.response.to.have.status(200); });",
              "const body = pm.response.json();",
              "pm.test('Health returns status OK', () => pm.expect(body.status).to.eql('OK'));",
              "pm.environment.set('serviceHealth', body.status);",
              "pm.environment.set('dbState', body.db || 'unknown');"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Create Category (SUV)",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"SUV\",\n  \"description\": \"Sport Utility Vehicle - spacious and versatile\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/categories",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Create Category - status 201', function () { pm.response.to.have.status(201); });",
              "const json = pm.response.json();",
              "pm.test('Response has data._id', () => { pm.expect(json).to.have.property('data'); pm.expect(json.data).to.have.property('_id'); });",
              "pm.test('Response has name', () => { pm.expect(json.data.name).to.equal('SUV'); });",
              "if (json && json.data && json.data._id) { pm.environment.set('categoryId_SUV', json.data._id); pm.test('categoryId_SUV saved', () => pm.expect(pm.environment.get('categoryId_SUV')).to.be.a('string')); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Create Category (Berline)",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"Berline\",\n  \"description\": \"Sedan - comfortable and efficient\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/categories",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Create Berline - status 201', function () { pm.response.to.have.status(201); });",
              "const json = pm.response.json();",
              "if (json && json.data && json.data._id) { pm.environment.set('categoryId_Berline', json.data._id); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - List Categories",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/categories",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('List Categories - status 200', () => pm.response.to.have.status(200));",
              "const body = pm.response.json();",
              "pm.test('Response has items array', () => { pm.expect(body).to.have.property('items'); pm.expect(body.items).to.be.an('array'); });",
              "pm.test('Has pagination meta', () => { pm.expect(body).to.have.property('meta'); pm.expect(body.meta).to.have.property('total'); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Get Category by ID",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/categories/{{categoryId_SUV}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories", "{{categoryId_SUV}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Get Category - status 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Response has name SUV', () => { pm.expect(json.data.name).to.equal('SUV'); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Update Category",
      "request": {
        "method": "PUT",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"description\": \"Updated: Premium SUV with luxury features\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/categories/{{categoryId_SUV}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories", "{{categoryId_SUV}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Update Category - status 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Description updated', () => { pm.expect(json.data.description).to.include('Updated'); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Duplicate name (should fail)",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"SUV\",\n  \"description\": \"Duplicate attempt\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/categories",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Duplicate category - status 400', function () { pm.response.to.have.status(400); });",
              "const body = pm.response.json();",
              "pm.test('Error message mentions already exists', () => pm.expect(body.message.toLowerCase()).to.include('already exists'));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Create Car with Category",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nom\": \"Test SUV 2024\",\n  \"category\": \"{{categoryId_SUV}}\",\n  \"prixParJour\": 85,\n  \"matricule\": \"CAR-SUV-{{randomInt}}\",\n  \"modele\": \"2024\",\n  \"marque\": \"Toyota\",\n  \"disponibilite\": true,\n  \"dernierMaintenance\": \"{{nowISO}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/cars",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "pm.environment.set('nowISO', new Date().toISOString());",
              "pm.environment.set('randomInt', Math.floor(Math.random()*100000));"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Create Car with category - status 201', function () { pm.response.to.have.status(201); });",
              "const json = pm.response.json();",
              "pm.test('Response has category populated', () => { pm.expect(json.data).to.have.property('category'); pm.expect(json.data.category).to.have.property('_id'); pm.expect(json.data.category.name).to.equal('SUV'); });",
              "if (json && json.data && json.data._id) { pm.environment.set('carId', json.data._id); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Create Car without Category (should fail)",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nom\": \"Car Without Category\",\n  \"prixParJour\": 50,\n  \"matricule\": \"BAD-CAR-{{randomInt}}\",\n  \"modele\": \"2024\",\n  \"marque\": \"Honda\",\n  \"dernierMaintenance\": \"{{nowISO}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/cars",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "pm.environment.set('randomInt', Math.floor(Math.random()*100000));"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Create Car without category - status 400', function () { pm.response.to.have.status(400); });",
              "const body = pm.response.json();",
              "pm.test('Has error message', () => pm.expect(body).to.have.property('message'));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Create Car with invalid Category ID (should fail)",
      "request": {
        "method": "POST",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"nom\": \"Car with bad category\",\n  \"category\": \"invalid-category-id\",\n  \"prixParJour\": 50,\n  \"matricule\": \"BAD-CAT-{{randomInt}}\",\n  \"modele\": \"2024\",\n  \"marque\": \"Honda\",\n  \"dernierMaintenance\": \"{{nowISO}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/cars",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars"]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "pm.environment.set('randomInt', Math.floor(Math.random()*100000));"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Create Car with invalid category - status 400', function () { pm.response.to.have.status(400); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - List Cars (populated with categories)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cars",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('List Cars status 200', () => pm.response.to.have.status(200));",
              "const body = pm.response.json();",
              "pm.test('List returns array with items', () => { pm.expect(body).to.have.property('items'); pm.expect(body.items).to.be.an('array'); });",
              "if (body && body.items && body.items.length > 0) { pm.test('First car has category populated', () => { pm.expect(body.items[0]).to.have.property('category'); pm.expect(body.items[0].category).to.have.property('_id'); pm.expect(body.items[0].category).to.have.property('name'); }); }"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Filter by Category",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cars?category={{categoryId_SUV}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars"],
          "query": [{"key": "category", "value": "{{categoryId_SUV}}"}]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Filter by category - status 200', () => pm.response.to.have.status(200));",
              "const body = pm.response.json();",
              "pm.test('All items have the requested category', () => { if (body.items && body.items.length > 0) { body.items.forEach(car => { pm.expect(car.category._id).to.equal(pm.environment.get('categoryId_SUV')); }); } });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Get Car by ID (with category)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cars/{{carId}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars", "{{carId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Get Car by ID - status 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Car has category populated', () => { pm.expect(json.data).to.have.property('category'); pm.expect(json.data.category).to.have.property('_id'); pm.expect(json.data.category.name).to.equal('SUV'); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Update Car (change category)",
      "request": {
        "method": "PATCH",
        "header": [{"key": "Content-Type", "value": "application/json"}],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"category\": \"{{categoryId_Berline}}\",\n  \"prixParJour\": 65\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/cars/{{carId}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars", "{{carId}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Update Car - status 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('Category changed to Berline', () => { pm.expect(json.data.category.name).to.equal('Berline'); });",
              "pm.test('Category is populated', () => { pm.expect(json.data.category).to.have.property('_id'); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cars - Search with category filter",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cars/search?category={{categoryId_Berline}}&limit=10",
          "host": ["{{baseUrl}}"],
          "path": ["api", "cars", "search"],
          "query": [{"key": "category", "value": "{{categoryId_Berline}}"}, {"key": "limit", "value": "10"}]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Search with category - status 200', () => pm.response.to.have.status(200));",
              "const body = pm.response.json();",
              "pm.test('Results have category populated', () => { if (body.items && body.items.length > 0) { pm.expect(body.items[0]).to.have.property('category'); pm.expect(body.items[0].category).to.have.property('name'); } });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Try delete category with cars (should fail)",
      "request": {
        "method": "DELETE",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/categories/{{categoryId_Berline}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories", "{{categoryId_Berline}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Delete category with cars - status 409 (Conflict)', function () { pm.response.to.have.status(409); });",
              "const body = pm.response.json();",
              "pm.test('Error message mentions cars using category', () => pm.expect(body.message.toLowerCase()).to.include('car'));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Categories - Delete category without cars",
      "request": {
        "method": "DELETE",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/categories/{{categoryId_SUV}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "categories", "{{categoryId_SUV}}"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Delete unused category - status 200', function () { pm.response.to.have.status(200); });",
              "const body = pm.response.json();",
              "pm.test('Deletion successful', () => pm.expect(body).to.have.property('data'));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    }
  ]
}
